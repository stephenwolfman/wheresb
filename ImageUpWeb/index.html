<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <title>Map Images</title>
    <script src="Scripts/jquery-1.7.1.min.js" type="text/javascript"></script>
<script src="Scripts/jquery-ui-1.8.20.min.js" type="text/javascript"></script>
<script src="Scripts/knockout-2.1.0.debug.js" type="text/javascript"></script>
<script src="Scripts/script.js" type="text/javascript"></script>
</head>
<body>

<div style="border:1px solid #000000;">

        <span>Select file to upload :</span>
    <input id="flMapImage" type="file" accept="image/*"  name="fileUp" multiple="multiple" />
    <input id="btnUploadFile" type="submit" value="Upload" />
</div>

  <div>
    <h2>All  MapImages</h2>
    <table id="tblMapImages">
        <thead id="tblHMapImages">
            <tr>
                <th>

                </th>
                <th>Lat</th>
                <th>Long</th>
                <th>Desc</th>
                <th>Sent By</th>
                <th>Comment</th>
                <th>Url</th>
                <th></th>
                <th></th>
            </tr>
        </thead>
        <tbody id="tblBMapImages"></tbody>
    </table>
  </div>
  <div>
    

  </div>
    <div>
        <ul style="list-style:none;">
            <li><span style="display:inline-block; width:100px;">Lat</span><input type="text" name="Lat" id="txtLat" /></li>
            <li><span style="display:inline-block; width:100px;">Long</span><input type="text" id="txtLong" /></li>
            <li><span style="display:inline-block; width:100px;">Desc</span><input type="text" id="txtDesc" /></li>
            <li><span style="display:inline-block; width:100px;">Sent By</span><input type="text" id="txtSentBy" /></li>
            <li><span style="display:inline-block; width:100px;">Comment</span><input type="text" id="txtComment" /></li>
            <li><span style="display:inline-block; width:100px;">Image Url</span><input type="text" id="txtImageUrl" readonly="true" /></li>
            <li><img id="imgMapImage" style="width:300px;height:200px;" src=""/></li>

        </ul>        
        <input id="btnMapImageSave" type="button" value="Save" onclick="UpdateMapImage(this);" />
    </div>

<!--<form action="/api/MapImages" method="post" enctype="multipart/form-data">-->


    <div id="dvImageDisplay">
        <img id="imgDisplay" style="height:200px;width:300px;"  />

    </div>

    <input id="btnDiscard" type="button" value="Discard" style="display:none;" />
<!--</form>-->

  <script type="text/javascript">


      var uri = 'api/MapImages';

      $(document).ready(function () {
          loadMapImages();

          $("#btnUploadFile").click(OnUpload);
          $("#btnDiscard").click(DiscardFile);
      });

      function loadMapImages() {
          // Send an AJAX request
          $.getJSON(uri)
              .done(function (data) {
                  // On success, 'data' contains a list of products.
                  $('#tblBMapImages tr td').unbind('click');
                  $('#tblBMapImages').empty();
                  $.each(data, function (key, item) {
                      // Add a list item for the product.
                      //$('<li>', { text: formatItem(item) }).appendTo($('#mapImages'));
                      $('#tblBMapImages').append(
                          $(document.createElement('tr')).append(
                              $(document.createElement('td')).append($(document.createElement('span')).html('edit').bind('click', function () { EditMapImage(item.MapImageId); }))
                          ).append(
                              $(document.createElement('td')).html(item.Lat)
                          ).append(
                              $(document.createElement('td')).html(item.Long)
                          ).append(
                              $(document.createElement('td')).html(item.Desc)
                          ).append(
                              $(document.createElement('td')).html(item.SentBy)
                          ).append(
                              $(document.createElement('td')).html(item.Comment)
                          ).append(
                              $(document.createElement('td')).html(item.ImageUrl)
                          ).append(
                              $(document.createElement('td')).html('delete')
                          ).append(
                              $(document.createElement('td')).html()
                          )
                      );
                  });
              });
      }


      function formatItem(item) {
          return item.Desc + ': $' + item.Comment;
      }

      function EditMapImage(id) {

          var uri = 'api/MapImages/{0}';
          uri = uri.replace('{0}', id);
          $.ajax({
              type: "GET",
              url: uri,
              contentType: false,
              processData: false,
              success: function (results) {
                  for (i = 0; i < results.length; i++) {
                      $('#txtLat').val(results[i].Lat);
                      $('#txtLong').val(results[i].Long);
                      $('#txtDesc').val(results[i].Desc);
                      $('#txtSentBy').val(results[i].SentBy);
                      $('#txtComment').val(results[i].Comment);
                      $('#txtImageUrl').val(results[i].ImageUrl);
                      $('#imgMapImage').attr('src', results[i].ImageUrl);
                      $('#btnMapImageSave').data('MapImageId', results[i].MapImageId);
                  }
              }
          });
      }

      function UpdateMapImage(evt) {

          var MapImageId = $(evt).data('MapImageId');
          var json = JSON.stringify(createMapImageJSON(MapImageId));


          $.ajax({
              url: '/api/MapImages/' + MapImageId,
              type: 'PUT',
              contentType: "application/json; charset=utf-8",
              data: json,
              success: function (results) {
                  alert("Successfully updated map image.");
                  loadMapImages();
              },
              error: function (error) {
                  alert(error);
              }
          });
      }

      function createMapImageJSON(id) {
          jsonObj = [];
          
            item = {}
            item["MapImageId"] = id;
            item["Lat"] = $('#txtLat').val();
            item["Long"] = $('#txtLong').val();
            item["Desc"] = $('#txtDesc').val();
            item["SentBy"] = $('#txtSentBy').val();
            item["ImageUrl"] = $('#txtImageUrl').val();

            jsonObj.push(item);


            return item;
      }

      function find() {
          var id = $('#prodId').val();
          $.getJSON(uri + '/' + id)
              .done(function (data) {
                  $('#product').text(formatItem(data));
              })
              .fail(function (jqXHR, textStatus, err) {
                  $('#product').text('Error: ' + err);
              });
      }


      function OnUpload(evt) {
          var files = $("#flMapImage").get(0).files;
          if (files.length > 0) {
              if (window.FormData !== undefined) {
                  var data = new FormData();
                  for (i = 0; i < files.length; i++) {
                      data.append("file" + i, files[i]);
                  }
                  $.ajax({
                      type: "POST",
                      url: "/api/Uploader",
                      contentType: false,
                      processData: false,
                      data: data,
                      success: function (results) {
                          alert("Successfully uploaded " + results.length + " file(s).");
                          loadMapImages();
                          /*for (i = 0; i < results.length; i++) {
                              //alert(results[i]);
                              $('#spnFileName').html(results[i].name);
                              $('#spnFileLat').html(results[i].Lat);
                              $('#spnFileLong').html(results[i].Long);
                              $('#imgDisplay').attr('src', results[i].imageUrl);
                          }*/
                      }
                  });
              } else {
                  alert("This browser doesn't support HTML5 file uploads!");
              }
          }
      }

      function DiscardFile() {
          var fileName = $('#spnFileName').html();

          var apiUrl = "api/uploader/{0}";
          apiUrl = apiUrl.replace("{0}", fileName);


                  $.ajax({
                      url: apiUrl,
                      type: 'DELETE',
                      cache: false,
                      statusCode: {
                          200: function (data) {
                          }, // Successful DELETE
                          404: function (data) {
                              alert(apiUrl + " ... Not Found");
                          }, // 404 Not Found
                          400: function (data) {
                              alert("Bad Request O");
                          } // 400 Bad Request
                      } // statusCode
                  }); // ajax call

      }
  </script>
</body>
</html>
